# Скрипт mender-convert

## Введение

Mender.io - решение, реализующее OTA (Other The Air) обновления для встроенных систем, построенных с помощью Yocto. Mender состоит из двух частей - клиент и сервер. Клиент работает на целевой системе как служба, которая периодически запрашивает у заданного сервера наличие обновлений. При появлении обновлений на сервере, клиент, в фоновом режиме, скачивает это обновление и сохраняет его во второй раздел.

Схема обновления предполагает, что корневая файловая система хранится в двух разделах - A/B. В то время, как один из разделов является активным, обновление сохраняется в неактивный раздел. При следующей загрузке активным становится раздел в который было сохранено обновление. Если обновление прошло успешно, то разделы меняются ролями. Раздел с обновлением назначается основным, а следующее обновление будет сохранено в другой раздел. Если же обновление признано неудачным, система возвращается к разделу в котором хранится предыдущая версия.

Основным препятствием к использованию Mender.io в наших разработках является то, что он, в первую очередь, предназначен для использования с Yocto. Данный дистрибутив очень сложен в усвоении и в сопровождении. Из моего опыта, сборка минимального референсного дистрибутива Yocto, занимает около четырех часов (Intel Core I7, 16 Gb ОЗУ). В дальнейшем это происходит быстрее, однако внесение изменений в конфигурацию сборки приводит к полной пересборке всего дистрибутива.

Дистрибутив Yocto очень хорошо подходит для построения систем с ограниченной функциональностью. Встроенные системы, разрабатываемые у нас, скорее являются системами общего назначения. Очевидных преимуществ у Yocto перед любым готовым дистрибутивом (Debian, Ubuntu, Astra), учитывая наши условия применения, нет.

## Применения mender с Debian

В документации к Mender указано, что он может быть использован в том числе и для дистрибутивов семейства Debian. Для этого используется специальный скрипт mender-convert. Из документации следует, что данному скрипту передается образ Debian системы, он распаковывает его, внедряет себя в систему и запаковывает образ обратно. Также изменения должны быть внесены в конфигурацию загрузчика (grub), для того, чтобы Mender мог переключать активные разделы.

## Постановка задачи

Задача состоит в том, чтобы проверить работу данного скрипта на установленном Debian. Для этого предлагается:

* установить в виртуальной машине любой дистрибутив семейства Debian в минимальной конфигурации, место на виртуальном диске выделить больше чем в два раза, чтобы осталось место для резервного раздела B и раздела данных;
* получить образ этого дистрибутива в виде файла; нужно определить как это сделать, может быть это просто `dd` корневого раздела;
* применить к данному образу скрипт mender-convert, рекомендую использовать его с Docker (в документации к скрипту это описано);
* образ, получившийся после работы скрипта, залить обратно на виртуальный диск и запустить получившуюся ОС;
* проверить, что в системе появилась служба mender;
* внести изменения в образ; тут есть неясность - по идее, нужно вносить изменения в начальный образ, который без добавок Mender. Снова применять к нему скрипт mender-convert и этот образ выкладывать на сервер обновлений. Если это не так, то нужно выяснить каким образом получить образ для обновления;
* выложить обновленный образ на локальный https сервер (если будут трудности, я запускал такой сервер в виде python скрипта);
* выполнить standalone обновление `mender -rootfs https://<httpsserver:port>/image-base.mender`;
* перезагрузить систему, убедиться в том, что загрузилась система с обновлением;
* зафиксировать обновление командой `mender commit`;
* считаем экспериент удачным;

Все действия необходимо записывать, чтобы потом их можно было воспроизвести.

## Результат

* установленный дистрибутив Debian, который можно обновить с помощью Mender;
* описание шагов, необходимых для выполнения такого обновления;

## Ссылки

Ссылки на документацию Mender по данному скрипту и к самому скрипту:

* [Документация debian family](https://docs.mender.io/2.3/devices/debian-family)
* [Скрипт mender convert](https://github.com/mendersoftware/mender-convert)
